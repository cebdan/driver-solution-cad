# Что было сделано: Рефакторинг на 4 независимых окна

## Обзор изменений

Проект был полностью переработан для работы с **4 независимыми GLFW окнами** вместо одного монолитного окна. Каждое окно имеет свою функциональность и может быть независимо управляемо пользователем.

## Архитектурные изменения

### 1. Рефакторинг класса Window

**Файлы:** `include/UI/Window.h`, `src/UI/Window.cpp`

**Изменения:**
- Вынесена инициализация GLFW (`glfwInit/glfwTerminate`) из конструктора/деструктора Window
- Добавлены статические методы `Window::initializeGLFW()` и `Window::terminateGLFW()`
- Теперь GLFW инициализируется один раз в Application для всех окон
- Это позволяет создавать несколько окон без конфликтов

**Причина:** GLFW должен инициализироваться один раз для всего приложения, а не для каждого окна отдельно.

### 2. Создание 4 независимых окон

**Файл:** `src/UI/Application.cpp`

**Окна:**
1. **windowTopBar_** (1920x100) - горизонтальная панель сверху
2. **windowLeftTools_** (80x800) - вертикальная панель инструментов слева
3. **windowMainView_** (1280x720) - основное 3D окно
4. **windowRightPanel_** (300x800) - правая панель с вкладками

**Особенности:**
- Каждое окно - отдельный `GLFWwindow*`
- Каждое окно имеет свой контекст OpenGL
- Окна можно независимо двигать, сворачивать, закрывать
- Приложение живёт, пока открыто хотя бы одно окно

### 3. Реализация рендеринга для каждого окна

**Методы:**
- `renderTopBar(Window*)` - рендеринг горизонтальной панели с 3 строками
- `renderLeftTools(Window*)` - рендеринг вертикальной панели инструментов
- `renderMainView(Window*)` - рендеринг 3D сцены с камерой
- `renderRightPanel(Window*)` - рендеринг правой панели с вкладками

**Главный цикл:**
- Обрабатывает все 4 окна в одном цикле
- Для каждого окна проверяет, не закрыто ли оно и не минимизировано
- Переключает контекст OpenGL перед рендерингом каждого окна
- Использует `glfwMakeContextCurrent()` для переключения контекстов

### 4. TopBar - горизонтальная панель (3 строки)

**Строка 1: Стандартное меню**
- Тёмная полоса с прямоугольными блоками
- Заглушки для меню: File, Edit, View, и т.д.
- Высота: 30px

**Строка 2: Контекстные инструменты**
- Связана с активным инструментом из LeftTools
- Показывает подгруппу инструментов выбранного типа
- Пример: если выбран Point в LeftTools, в строке 2 показываются "Point", "Point on Curve", "Midpoint"
- Высота: 30px

**Строка 3: Слои**
- Круглые кнопки с номерами (1, 2, 3, ...)
- Каждая кнопка может иметь разный цвет фона в зависимости от состояния:
  - Активный слой: синий фон
  - Скрытый слой: тёмно-серый фон
  - Видимый, но неактивный: цвет зависит от `layer.color`
- Связана с MainView (активный слой влияет на отображение)
- Высота: 15px (половина от строки 1)

### 5. LeftTools - вертикальная панель инструментов

**Инструменты:**
- Select, Point, Line, Circle, Extrude, Revolve, Boolean
- Каждый инструмент - прямоугольная кнопка с иконкой-заглушкой
- Активный инструмент подсвечивается синим цветом
- Клик по инструменту:
  1. Активирует инструмент (подсветка)
  2. Обновляет строку 2 в TopBar (показывает подгруппу)

**Структура ToolGroup:**
```cpp
struct ToolGroup {
    ToolType tool;
    std::vector<std::string> subTools;  // Подгруппа для TopBar row 2
};
```

### 6. MainView - основное 3D окно

**Функциональность:**
- 3D сцена с координатными осями (X-красный, Y-зелёный, Z-синий)
- Рендеринг Solutions из Kernel
- Навигатор-куб в правом верхнем углу
- Камера с управлением:
  - **ЛКМ + движение**: вращение (orbit)
  - **Колесо мыши**: зум (zoom)
  - **Средняя кнопка + движение**: панорамирование (pan)

**Связь со слоями:**
- Активный слой из TopBar строка 3 влияет на отображение (пока заглушка, фильтрация по слоям будет реализована позже)

### 7. RightPanel - правая панель с вкладками

**Вкладки:**
- Tree (дерево построения)
- Info (информация)
- Properties (свойства)

**Реализация:**
- Вкладки вверху панели
- Активная вкладка подсвечивается
- Контентная область под вкладками (пока заглушка)

### 8. Обработка событий мыши

**Методы:**
- `handleTopBarClick()` - обработка кликов в TopBar (слои в строке 3)
- `handleLeftToolsClick()` - обработка кликов в LeftTools (выбор инструмента)
- `handleMainViewMouse()` - обработка мыши в MainView (камера)
- `handleRightPanelClick()` - обработка кликов в RightPanel (переключение вкладок)

**Hit testing:**
- `hitTestLeftTool()` - определение, по какому инструменту кликнули
- `hitTestTopBarRow3()` - определение, по какой кнопке слоя кликнули
- `hitTestRightTab()` - определение, по какой вкладке кликнули

### 9. Связи между окнами

**LeftTools → TopBar строка 2:**
- При выборе инструмента в LeftTools
- Обновляется строка 2 в TopBar
- Показываются подгруппы инструментов выбранного типа

**TopBar строка 3 → MainView:**
- При клике на круглую кнопку слоя
- Активируется слой
- MainView должен фильтровать отображение по активному слою (пока заглушка)

### 10. Исправления и улучшения

**Исправление M_PI для MSVC:**
- В `src/Solutions/ConstraintSolution.cpp` добавлена проверка `#ifndef M_PI`
- MSVC не определяет M_PI по умолчанию

**Поддержка vcpkg для Windows:**
- В `CMakeLists.txt` добавлена поддержка поиска GLFW через vcpkg
- Автоматическое определение платформы (Windows/macOS/Linux)

**Исправление проблемы с закрытием при сворачивании:**
- Добавлена проверка размера framebuffer (0x0 при минимизации)
- Пропуск рендеринга для минимизированных окон
- Приложение больше не крашится при сворачивании/разворачивании

## Технические детали

### Управление контекстами OpenGL

Каждое окно имеет свой контекст OpenGL. Перед рендерингом каждого окна:
```cpp
glfwMakeContextCurrent(window->getHandle());
```

Это позволяет каждому окну иметь независимое состояние OpenGL.

### Главный цикл

```cpp
while (true) {
    // Проверка, все ли окна закрыты
    if (allClosed) break;
    
    glfwPollEvents();  // Обработка событий для всех окон
    
    // Рендеринг каждого окна
    if (windowTopBar_ && !windowTopBar_->shouldClose()) {
        glfwMakeContextCurrent(windowTopBar_->getHandle());
        renderTopBar(windowTopBar_.get());
        windowTopBar_->swapBuffers();
    }
    // ... аналогично для остальных окон
}
```

### Инициализация слоёв

По умолчанию создаётся 10 слоёв:
- ID: 1-10
- Имена: "Layer 1", "Layer 2", ...
- По умолчанию все видимые, активен слой 1

### Инициализация групп инструментов

Каждый инструмент имеет подгруппу:
- Select: "Select", "Box Select", "Lasso"
- Point: "Point", "Point on Curve", "Midpoint"
- Line: "Line", "Polyline", "Spline"
- Circle: "Circle", "Arc", "Ellipse"
- Extrude: "Extrude", "Extrude Along Path", "Sweep"
- Revolve: "Revolve", "Revolve 360", "Revolve Partial"
- Boolean: "Union", "Cut", "Intersection"

## Статистика изменений

- **6 файлов изменено**
- **806 строк добавлено**
- **699 строк удалено**
- **Коммит:** `d42eaeb` - "Refactor to 4 independent windows architecture"

## Совместимость

- ✅ **macOS** (Apple Silicon & Intel)
- ✅ **Windows** (с vcpkg)
- ✅ **Linux**
- Код полностью кроссплатформенный, использует только стандартные GLFW API

## Следующие шаги (TODO)

1. Реализовать фильтрацию Solutions по слоям в MainView
2. Добавить реальные иконки для инструментов в LeftTools
3. Реализовать контент для вкладок в RightPanel
4. Добавить функциональность для пунктов меню в TopBar строка 1
5. Реализовать создание объектов при выборе инструментов

